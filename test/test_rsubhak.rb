# encoding: utf-8
require 'test_helper'

class RsubhakTest < Test::Unit::TestCase

  def test_remove_dollar_sign_and_commas_from_price_string_key_in_enclosing_array
    input= [{"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}]
    expect=[{"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"1500000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}]
    assert_equal expect,
      Rsubhak.rsubhak(input, 'price', /[\$,]/, '')
  end

  def test_remove_dollar_sign_and_commas_from_price_string_key
    input= {"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    expect={"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"1500000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    assert_equal expect,
      Rsubhak.rsubhak(input, 'price', /[\$,]/, '')
  end

  def test_remove_dollar_sign_and_commas_from_price_symbol_key
    input= {"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    expect={"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"2500000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"6000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    assert_equal expect,
      Rsubhak.rsubhak(input, :price, /[\$,]/, '')
  end

  def test_remove_commas_from_quantity_string_key
    input= {"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    expect={"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"$2,500,000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"$6,000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5000"}], {"stockroom_id"=>"46", "quantity"=>"1000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12000000000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    assert_equal expect,
      Rsubhak.rsubhak(input, 'quantity', /,/, '')
  end

  def test_remove_euro_sign_and_periods_from_price_symbol_key
    input= {"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"€2.500.000,00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"€6.000,00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    expect={"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"2500000,00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"6000,00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    intermediary = Rsubhak.rsubhak(input, :price, /[€\.]/, '')
    assert_equal expect, intermediary
    expect={"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"2500000.00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"6000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    assert_equal expect,
      Rsubhak.rsubhak(intermediary, :price, /,/, '.')
  end

  def test_remove_all_currency_signs_and_commas_and_convert_comma_decimal_separator_to_periods_all_prices_and_quantities
    input= {"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"€2.500.000,00", "price"=>"$1,500,000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"$10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"$5.00"}, "fff"=>{:price=>"€6.000,00"}}], {"stockroom_id"=>"45", "quantity"=>"5,000"}], {"stockroom_id"=>"46", "quantity"=>"1,000", "x"=>["xyz", {"price"=>"$4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12,000,000,000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    expect={"utf8"=>"✓", "authenticity_token"=>"N2gqZ3+Zm8JDsXg94/7lB3AZSB5o3PLxPHPbDJRvhkI=", :price=>"2500000.00", "price"=>"1500000.00", "corn"=>{"corn_category_id"=>"299", "country_name"=>"x", "region_name"=>"x", "producer_name"=>"x", "name"=>"x", "year"=>"2012", "new_corny_attributes"=>{"1333074807.696388"=>{"leaf_variation"=>{"name"=>"x", "_delete"=>""}}}, "description"=>"x", "price"=>"10.00", "remote_image_url"=>"", "new_inventory_attributes"=>["aaa", 123, [123, [123, "bbb", {"ccc"=>"ddd", "eee"=>{"price"=>"5.00"}, "fff"=>{:price=>"6000.00"}}], {"stockroom_id"=>"45", "quantity"=>"5000"}], {"stockroom_id"=>"46", "quantity"=>"1000", "x"=>["xyz", {"price"=>"4.00"}, "", []]}, {"stockroom_id"=>"47", "quantity"=>"0.01"}, {"stockroom_id"=>"48", "quantity"=>"12000000000"}], "publishable"=>"0"}, "commit"=>"Save this thing"}
    Rsubhak.rsubhak(input, :price, /[€\.]/, '')
    Rsubhak.rsubhak(input, :price, /,/, '.')
    Rsubhak.rsubhak(input, 'price', /[\$,]/, '')
    assert_equal expect,
      Rsubhak.rsubhak(input, 'quantity', /,/, '')
  end

  def test_readme_rdoc_example
    input= {"utf8"=>"✓", "authenticity_token"=>"xyz", "type"=>"cheese", "cheese"=>{"cheese_category_id"=>"299", "country_name"=>"France", "region_name"=>"Savoie", "producer_name"=>"aaa", "name"=>"bbb", "year"=>"2001", "new_grapeage_attributes"=>{"1333074807.696388"=>{"cheese_variation"=>{"name"=>"ccc", "_delete"=>""}}}, "description"=>"ddd", "price"=>"$100.00", "remote_image_url"=>"", "new_variant_attributes"=>[{"variation_id"=>"46", "price"=>"$150.00"}, {"variation_id"=>"47", "price"=>"$1,500"}, {"variation_id"=>"48", "price"=>"$10,500"}], "publishable"=>"0"}, "commit"=>"Save this cheese"}
    expect={"utf8"=>"✓", "authenticity_token"=>"xyz", "type"=>"cheese", "cheese"=>{"cheese_category_id"=>"299", "country_name"=>"France", "region_name"=>"Savoie", "producer_name"=>"aaa", "name"=>"bbb", "year"=>"2001", "new_grapeage_attributes"=>{"1333074807.696388"=>{"cheese_variation"=>{"name"=>"ccc", "_delete"=>""}}}, "description"=>"ddd", "price"=>"100.00", "remote_image_url"=>"", "new_variant_attributes"=>[{"variation_id"=>"46", "price"=>"150.00"}, {"variation_id"=>"47", "price"=>"1500"}, {"variation_id"=>"48", "price"=>"10500"}], "publishable"=>"0"}, "commit"=>"Save this cheese"}
    assert_equal expect,
      Rsubhak.rsubhak(input, 'price', /[\$,]/, '')
  end

end
